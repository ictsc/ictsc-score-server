version: '3'

services:
  api:
    image: upluse10/ictsc-score-server:api-develop
    env_file: .env
    build:
      context: api/
    depends_on:
      - db
      - redis
    ports: ['127.0.0.1:8900:3000']
    stdin_open: true
    tty: true
    volumes:
      - './api:/usr/src/app'
    command: sh -c '
      if [ -f "tmp/pids/server.pid" ]; then
        rm tmp/pids/server.pid;
      fi

      dockerize -wait tcp://redis:6379 -timeout 100s
      dockerize -wait tcp://db:5432 -timeout 100s
      bundle exec rails server -b 0.0.0.0
      '

  ui:
    image: upluse10/ictsc-score-server:ui-develop
    env_file: .env
    build:
      context: ui/
    ports: ['127.0.0.1:8901:3000']
    tty: true
    volumes:
      - './ui:/usr/src/app'
    # ビルドに失敗してもリトライ(restart: on-failure は使いづらい)
    command: sh -c '
      while :; do
        yarn run dev;
        sleep 1;
      done
      '

  db:
    image: postgres:11.3-alpine
    env_file: .env
    ports: ['127.0.0.1:8902:5432']
    volumes:
      # ログを取得するため
      - ./postgres/pgdata:/var/lib/postgresql/data
    command:
      - 'postgres'
      - '-c'
      - 'max_connections=$POSTGRES_MAX_CONNECTIONS'
      - '-c'
      - 'shared_buffers=$POSTGRES_SHARED_BUFFERS'
      - '-c'
      - 'work_mem=$POSTGRES_WORK_MEM'
      - '-c'
      - 'log_statement=all'
      - '-c'
      - 'log_connections=on'
      - '-c'
      - 'log_disconnections=on'
      - '-c'
      - 'log_destination=stderr'
      # - '-c'
      # - 'logging_collector=on'
      # - '-c'
      # - 'log_filename=postgresql.log'

  redis:
    image: redis:5.0.4-alpine
    env_file: .env
    ports: ['127.0.0.1:8903:6379']

  datadog:
    image: datadog/agent:6.14.0
    env_file: .env
    environment:
     - DD_APM_ENABLED=true
     - DD_APM_NON_LOCAL_TRAFFIC=true
     - DD_LOGS_ENABLED=true
    volumes:
     - /var/run/docker.sock:/var/run/docker.sock:ro
     - /proc/:/host/proc/:ro
     - /sys/fs/cgroup:/host/sys/fs/cgroup:ro

  fluentd:
    image: fluentd:v1.6-1
    env_file: .env
    volumes:
      - ./log:/fluentd/log

  yamllint:
    image: upluse10/ictsc-score-server:yamllint
    build:
      context: yamllint/
    volumes:
      - './:/usr/src/app'
    command: yamllint -c /usr/src/app/.yamllint /usr/src/app
